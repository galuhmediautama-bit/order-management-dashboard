// ============================================
// RLS TEST - Copy-paste langsung ke browser console
// ============================================

(async function testRLS() {
  console.log('ğŸ§ª Testing RLS after QUICK_FIX_RLS_SIMPLE.sql...\n');
  
  try {
    // Check if supabase object exists in window
    if (!window.supabaseClient) {
      console.error('âŒ Supabase client not found in window.supabaseClient');
      console.log('Trying alternative: check for supabase in imported modules...');
    }
    
    // Get auth token from localStorage
    const authToken = localStorage.getItem('sb-jnkbysrjfdwsznsrvwhz-auth-token');
    if (!authToken) {
      console.error('âŒ No auth token found - user not authenticated');
      return;
    }
    
    const tokenObj = JSON.parse(authToken);
    const accessToken = tokenObj.access_token;
    
    console.log('âœ… Found auth token, testing queries...\n');
    
    const supabaseUrl = 'https://jnkbysrjfdwsznsrvwhz.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impua2J5c3JqZmR3c3puc3J2d2h6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE2ODYwMzA4NDcsImV4cCI6MTk5OTY0MDg0N30.oRtYrSYszZXy_08-QdxAs22xC6NdIR-4';
    
    // Test 1: Users SELECT
    console.log('ğŸ“‹ Test 1: SELECT from users table');
    const usersRes = await fetch(
      `${supabaseUrl}/rest/v1/users?select=id,email,role,status&limit=5`,
      {
        headers: {
          'apikey': supabaseKey,
          'Authorization': `Bearer ${accessToken}`,
          'Content-Type': 'application/json'
        }
      }
    );
    const users = await usersRes.json();
    console.log(`Status: ${usersRes.status}`, users.length > 0 ? `âœ… Found ${users.length} users` : users[0]?.message ? `âŒ ${users[0].message}` : 'âŒ No users');
    if (users.length > 0) console.log('Sample user:', users[0]);
    
    // Test 2: Orders SELECT
    console.log('\nğŸ“¦ Test 2: SELECT from orders table');
    const ordersRes = await fetch(
      `${supabaseUrl}/rest/v1/orders?select=id,status&limit=10`,
      {
        headers: {
          'apikey': supabaseKey,
          'Authorization': `Bearer ${accessToken}`,
          'Content-Type': 'application/json'
        }
      }
    );
    const orders = await ordersRes.json();
    console.log(`Status: ${ordersRes.status}`, orders.length > 0 ? `âœ… Found ${orders.length} orders` : orders[0]?.message ? `âŒ ${orders[0].message}` : 'âŒ No orders');
    
    // Test 3: Settings SELECT
    console.log('\nâš™ï¸  Test 3: SELECT from settings table');
    const settingsRes = await fetch(
      `${supabaseUrl}/rest/v1/settings?select=id&limit=1`,
      {
        headers: {
          'apikey': supabaseKey,
          'Authorization': `Bearer ${accessToken}`,
          'Content-Type': 'application/json'
        }
      }
    );
    const settings = await settingsRes.json();
    console.log(`Status: ${settingsRes.status}`, settings.length > 0 ? `âœ… Found settings` : settings[0]?.message ? `âŒ ${settings[0].message}` : 'âš ï¸  No settings');
    
    console.log('\nâœ¨ RLS Test Complete!');
    console.log('\nğŸ“Š Summary:');
    console.log('- Users query:', usersRes.status === 200 ? 'âœ… OK' : `âŒ ${usersRes.status}`);
    console.log('- Orders query:', ordersRes.status === 200 ? 'âœ… OK' : `âŒ ${ordersRes.status}`);
    console.log('- Settings query:', settingsRes.status === 200 ? 'âœ… OK' : `âŒ ${settingsRes.status}`);
    console.log('\nIf all are 200: RLS is now permissive âœ…');
    console.log('If any are 403: RLS is still blocking queries âŒ');
    
  } catch (error) {
    console.error('âŒ Error during test:', error);
  }
})();
